#!/usr/bin/env bash

set -e

spec_dir="/var/vcap/jobs/apply-specs/specs"
config_dir="/var/vcap/jobs/apply-specs/config"

kubectl="/var/vcap/packages/kubernetes/bin/kubectl --kubeconfig=/var/vcap/jobs/apply-specs/config/kubeconfig"

apply_spec() {
  local spec_file="${spec_dir}/${1}"
  echo "Deploying $spec_file"
  ${kubectl} apply -f "${spec_file}"
}

wait_for() {
    ${kubectl} rollout status "deployments/${1}" -w --namespace=kube-system
}

main() {

<%
  supported_addons = ['coredns', 'metrics-server', 'kubernetes-dashboard']

  bootstrap_addons = p('addons')

  bootstrap_addons = bootstrap_addons.each do |v|
    raise "#{v} is not a supported addon" unless supported_addons.include?(v)
  end
%>

<% if bootstrap_addons.include?('coredns') %>
  apply_spec "coredns.yml"
  wait_for coredns
<% end %>

<% if bootstrap_addons.include?('metrics-server') %>
  apply_spec "metrics-server.yml"
  wait_for metrics-server
<% end %>

<% if bootstrap_addons.include?('kubernetes-dashboard') %>
  apply_spec "kubernetes-dashboard.yml"
  wait_for kubernetes-dashboard
<% end %>

<% if !p('specs.addons').empty? and p('specs.addons') != "nil" %>
  apply_spec "addons.yml"
  <% else %>
  echo "No addons to apply."
<% end %>
}

main
